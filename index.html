<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>EHS Mobile App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html { height: 100%; }
        body {
            height: 100%;
            margin: 0;
            background-color: #f1f5f9; /* slate-100 */
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        #mobile-frame {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        #app-container {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            background-color: #f1f5f9; /* slate-100 */
        }
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f1f5f9; /* slate-100 */
            transition: transform 0.4s cubic-bezier(0.45, 0, 0.55, 1);
            transform: translateX(100%);
            overflow-y: auto;
            display: flex; 
            flex-direction: column;
        }
        .screen.active { transform: translateX(0); }
        .screen.exit-left { transform: translateX(-100%); }
        .screen::-webkit-scrollbar { width: 4px; }
        .screen::-webkit-scrollbar-track { background: transparent; }
        .screen::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        #bottom-nav { display: none; }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="mobile-frame">
        <div id="app-container">

            <!-- URL Entry Screen -->
            <div id="url-screen" class="screen active p-8 justify-center bg-white">
                <div class="text-center"><h1 class="text-3xl font-extrabold text-slate-900">Welcome</h1><p class="mt-2 text-slate-500">Enter your application URL.</p></div>
                <form id="url-form" class="space-y-6 mt-8"><input id="app-url" name="url" type="url" required class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="https://yourapp.example.com" value="https://yourapp.example.com"><button type="submit" class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 active:scale-95 transition-transform">Connect</button></form>
            </div>

            <!-- Login Screen -->
            <div id="login-screen" class="screen p-8 justify-center bg-white">
                <div class="text-center"><h1 class="text-3xl font-extrabold text-slate-900">Sign In</h1><p class="mt-2 text-slate-500">Access your EHS Dashboard</p></div>
                <form id="login-form" class="space-y-6 mt-8"><input type="text" id="username" required class="w-full px-4 py-3 border border-slate-300 rounded-lg" placeholder="Username" value="demo_user"><input type="password" id="password" required class="w-full px-4 py-3 border border-slate-300 rounded-lg" placeholder="Password" value="password"><div class="flex items-center justify-between"><span id="captcha" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg text-lg tracking-widest select-none"></span><input type="text" id="captcha-input" required class="w-1/2 px-4 py-3 border border-slate-300 rounded-lg" placeholder="Enter CAPTCHA"></div><p id="login-error" class="text-red-500 text-sm h-4"></p><button type="submit" class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 active:scale-95 transition-transform flex items-center justify-center">Login</button></form>
            </div>
            
            <!-- Main Application Screens -->
            <div id="main-app" class="screen">
                <header id="main-header" class="bg-slate-100/80 backdrop-blur-sm sticky top-0 z-10 p-4 border-b border-slate-200 flex items-center justify-between h-16">
                    <div class="absolute inset-0 flex items-center justify-center"><h1 id="header-title" class="text-lg font-bold text-slate-800">Menus</h1></div>
                    <button id="header-back-btn" class="hidden z-20 p-2 rounded-full hover:bg-slate-200 transition-opacity duration-300 opacity-0"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></button>
                </header>
                
                <main id="main-content-area" class="p-4 overflow-y-auto flex-grow">
                    <div id="menus-view" class="main-screen active"><div class="grid grid-cols-2 gap-4"></div></div>
                    <div id="dashboard-view" class="main-screen hidden"><div id="dashboard-tabs" class="flex items-center gap-2 mb-4 overflow-x-auto pb-2 -mx-4 px-4"></div><div id="dashboard-content" class="space-y-6"></div></div>
                    <div id="profile-view" class="main-screen hidden"><div class="bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-bold text-slate-900 mb-6">User Profile</h2><form id="profile-form" class="space-y-6"><div><label class="block text-sm font-medium">Full Name</label><input type="text" value="John Doe" class="mt-1 w-full px-4 py-2 border border-slate-300 rounded-lg bg-slate-100"></div><div><label class="block text-sm font-medium">Email Address</label><input type="email" value="john.doe@example.com" class="mt-1 w-full px-4 py-2 border border-slate-300 rounded-lg bg-slate-100"></div><div><label class="block text-sm font-medium">Change Password</label><input type="password" placeholder="New Password" class="mt-1 w-full px-4 py-2 border border-slate-300 rounded-lg bg-slate-100"></div><div class="text-right pt-4"><button type="submit" class="py-2 px-6 bg-indigo-600 text-white font-semibold rounded-lg">Save</button></div></form></div></div>
                    <div id="incident-management-module" class="main-screen hidden">
                        <div id="im-list-view">
                            <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-slate-900">Incidents</h2><button id="im-new-report-btn" class="flex items-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md text-sm active:scale-95 transition-transform"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg><span>New</span></button></div>
                            <div id="im-list-container" class="space-y-3"></div>
                        </div>
                        <div id="im-form-view" class="hidden bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-bold mb-4 text-center">Report New Incident</h2><form id="im-form" class="space-y-4"><div><label for="im-title" class="block text-sm font-medium">Title <span class="text-red-500">*</span></label><input type="text" id="im-title" name="title" required class="w-full px-3 py-2 border rounded-lg bg-slate-100"></div><div><label for="im-description" class="block text-sm font-medium">Description <span class="text-red-500">*</span></label><textarea id="im-description" name="description" required class="w-full px-3 py-2 border rounded-lg bg-slate-100" rows="3"></textarea></div><div class="relative"><label for="im-location" class="block text-sm font-medium">Location <span class="text-red-500">*</span></label><input type="text" id="im-location" name="location" required class="w-full px-3 py-2 border rounded-lg bg-slate-100 pr-10"><button type="button" id="im-get-location-btn" class="absolute bottom-1 right-1 p-2 text-indigo-600 hover:bg-slate-200 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><line x1="22" y1="12" x2="18" y2="12"></line><line x1="6" y1="12" x2="2" y2="12"></line><line x1="12" y1="6" x2="12" y2="2"></line><line x1="12" y1="22" x2="12" y2="18"></line></svg></button></div><div class="grid grid-cols-2 gap-4"><div><label for="im-plant" class="block text-sm font-medium">Plant</label><select id="im-plant" name="plant" class="w-full px-3 py-2 border rounded-lg bg-slate-100"><option value="">Select Plant</option></select></div><div><label for="im-department" class="block text-sm font-medium">Department</label><select id="im-department" name="department" class="w-full px-3 py-2 border rounded-lg bg-slate-100"><option value="">Select Dept</option></select></div></div><div><label class="block text-sm font-medium">Evidence</label><div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-md"><div class="space-y-1 text-center"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-slate-400"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg><div class="flex text-sm text-slate-600"><label for="im-file-upload" class="relative cursor-pointer bg-transparent rounded-md font-medium text-indigo-600 hover:text-indigo-500"><span>Upload files</span><input id="im-file-upload" name="file-upload" type="file" class="sr-only" multiple></label></div></div></div><div id="im-file-list" class="mt-2 space-y-1"></div></div><div class="flex items-center justify-end gap-2 pt-4 border-t"><button type="button" id="im-cancel-btn" class="py-2 px-4 bg-slate-200 font-semibold rounded-lg text-sm">Cancel</button><button type="submit" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg text-sm">Submit</button></div></form></div>
                        <div id="im-detail-view" class="hidden bg-white p-6 rounded-xl shadow-md"></div>
                    </div>
                    <div id="wip-view" class="main-screen hidden text-center pt-16"><h2 class="text-xl font-bold">Work in Progress</h2><p class="text-slate-500 mt-2">This feature is coming soon.</p></div>
                </main>
            </div>
        </div>
        
        <nav id="bottom-nav" class="w-full bg-white border-t border-slate-200 grid grid-cols-3 shadow-inner"><button data-target="menus-view" data-title="Menus" class="nav-btn p-3 flex flex-col items-center gap-1 text-indigo-600"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg><span class="text-xs font-semibold">Menus</span></button><button data-target="dashboard-view" data-title="Dashboard" class="nav-btn p-3 flex flex-col items-center gap-1 text-slate-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg><span class="text-xs font-semibold">Dashboard</span></button><button data-target="profile-view" data-title="Profile" class="nav-btn p-3 flex flex-col items-center gap-1 text-slate-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg><span class="text-xs font-semibold">Profile</span></button></nav>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- App State & Elements ---
        let currentScreenId = 'url-screen';
        let lastMainScreenId = 'menus-view';
        let chartInstances = {};
        const headerTitle = document.getElementById('header-title');
        const headerBackBtn = document.getElementById('header-back-btn');
        const bottomNav = document.getElementById('bottom-nav');
        
        // --- Navigation ---
        function showScreen(screenId) {
            const newScreen = document.getElementById(screenId);
            const oldScreen = document.getElementById(currentScreenId);
            if (oldScreen && newScreen && oldScreen !== newScreen) {
                oldScreen.classList.add('exit-left');
                newScreen.classList.add('active');
                setTimeout(() => oldScreen.classList.remove('active', 'exit-left'), 400);
            }
            currentScreenId = screenId;
            bottomNav.style.display = (currentScreenId === 'main-app') ? 'grid' : 'none';
        }
        
        function showMainScreen(screenId, title) {
            document.querySelectorAll('.main-screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            headerTitle.textContent = title;
            const isSubPage = !['menus-view', 'dashboard-view', 'profile-view'].includes(screenId);
            headerBackBtn.classList.toggle('hidden', !isSubPage);
            headerBackBtn.style.opacity = isSubPage ? '1' : '0';
            if (!isSubPage) {
                lastMainScreenId = screenId;
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.replace('text-indigo-600', 'text-slate-500'));
                const activeBtn = document.querySelector(`.nav-btn[data-target="${screenId}"]`);
                if (activeBtn) activeBtn.classList.replace('text-slate-500', 'text-indigo-600');
            } else {
                 document.querySelectorAll('.nav-btn').forEach(b => b.classList.replace('text-indigo-600', 'text-slate-500'));
            }
        }

        // --- Event Delegation for Main App ---
        document.getElementById('main-app').addEventListener('click', (e) => {
            const moduleTile = e.target.closest('.module-tile');
            if (moduleTile) {
                const moduleName = moduleTile.dataset.name;
                const targetScreen = (moduleName === 'Incident Mgt.') ? 'incident-management-module' : 'wip-view';
                showMainScreen(targetScreen, moduleName);
            }
        });

        // --- Initial Screens & Login Logic ---
        document.getElementById('url-form').addEventListener('submit', (e) => { e.preventDefault(); showScreen('login-screen'); generateCaptcha(); });
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        loginForm.addEventListener('submit', (e) => { 
            e.preventDefault(); 
            loginError.textContent = '';
            if (document.getElementById('captcha-input').value.toLowerCase() !== captchaText.toLowerCase()) {
                loginError.textContent = 'Invalid CAPTCHA. Please try again.';
                generateCaptcha();
                return;
            }
            showScreen('main-app'); 
            showMainScreen('menus-view', 'Menus');
        });
        document.getElementById('profile-form').addEventListener('submit', (e) => { e.preventDefault(); alert('Profile saved!'); });
        headerBackBtn.addEventListener('click', () => { 
            const lastMainScreenTitle = document.querySelector(`.nav-btn[data-target="${lastMainScreenId}"]`).dataset.title;
            showMainScreen(lastMainScreenId, lastMainScreenTitle);
        });
        document.querySelectorAll('.nav-btn').forEach(btn => { btn.addEventListener('click', () => { showMainScreen(btn.dataset.target, btn.dataset.title); }); });

        // --- CAPTCHA ---
        const captchaEl = document.getElementById('captcha');
        let captchaText = '';
        function generateCaptcha() { captchaText = Math.random().toString(36).substring(2, 7).toUpperCase(); captchaEl.textContent = captchaText; document.getElementById('captcha-input').value = ''; }

        // --- Modules Setup ---
        const modules = [
            { name: "Incident Mgt.", icon: '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>', color: 'bg-red-100' },
            { name: "Work Permit", icon: '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line></svg>', color: 'bg-blue-100' },
            { name: "Compliance", icon: '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>', color: 'bg-green-100' },
            { name: "Contractor", icon: '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline></svg>', color: 'bg-yellow-100' },
            { name: "Chemicals", icon: '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-500"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>', color: 'bg-purple-100' },
            { name: "Audit", icon: '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-pink-500"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>', color: 'bg-pink-100' }
        ];
        document.querySelector('#menus-view .grid').innerHTML = modules.map(m => `<button data-name="${m.name}" class="module-tile bg-white p-4 rounded-xl shadow-md text-center flex flex-col items-center justify-center gap-2 hover:shadow-lg hover:-translate-y-0.5 transition-all active:scale-95"><div class="w-12 h-12 flex items-center justify-center rounded-full ${m.color}">${m.icon}</div><span class="font-semibold text-slate-800 text-sm">${m.name}</span></button>`).join('');
        
        // --- Incident Management Module Logic ---
        const im = {
            listView: document.getElementById('im-list-view'),
            formView: document.getElementById('im-form-view'),
            detailView: document.getElementById('im-detail-view'),
            listContainer: document.getElementById('im-list-container'),
            form: document.getElementById('im-form'),
            plantSelect: document.getElementById('im-plant'),
            departmentSelect: document.getElementById('im-department'),
            fileUpload: document.getElementById('im-file-upload'),
            fileList: document.getElementById('im-file-list'),
        };
        let incidents = [ { id: 1, title: "Minor Slip and Fall", status: "Open", location: "Warehouse A", description: "An employee slipped on a wet patch near the east entrance of Warehouse Section A. No major injuries reported.", plant: "Main Facility", department: "Logistics", files: [] }, { id: 2, title: "Forklift Collision", status: "In Progress", location: "Dock 3", description: "A forklift operator collided with a stack of pallets due to a reported brake malfunction.", plant: "Logistics Hub", department: "Logistics", files: ["forklift_damage.jpg"] }, { id: 3, title: "Power Outage", status: "Closed", location: "West Wing", description: "A scheduled power outage for maintenance was completed successfully.", plant: "West Wing", department: "Maintenance", files: [] }];
        const plants = ["Main Facility", "West Wing", "Logistics Hub", "East Wing"];
        const departments = ["Logistics", "Maintenance", "Health & Safety", "Operations"];
        plants.forEach(p => im.plantSelect.innerHTML += `<option value="${p}">${p}</option>`);
        departments.forEach(d => im.departmentSelect.innerHTML += `<option value="${d}">${d}</option>`);
        
        const renderIncidentList = () => { im.listContainer.innerHTML = incidents.map(incident => { const statusStyles = { Open: 'border-green-500', 'In Progress': 'border-yellow-500', Closed: 'border-slate-400' }; return `<div data-id="${incident.id}" class="im-card bg-white p-3 rounded-lg shadow-sm border-l-4 ${statusStyles[incident.status]} cursor-pointer"><h3 class="font-bold text-slate-800">${incident.title}</h3><p class="text-sm text-slate-500">${incident.location}</p></div>`; }).join(''); };
        const showIncidentDetail = (id) => { const incident = incidents.find(i => i.id === id); const statusStyles = { Open: 'bg-green-100 text-green-800', 'In Progress': 'bg-yellow-100 text-yellow-800', Closed: 'bg-slate-200 text-slate-600' }; im.detailView.innerHTML = `<div class="flex justify-between items-start"><h2 class="text-xl font-bold mb-4">${incident.title}</h2><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusStyles[incident.status]}">${incident.status}</span></div><div class="space-y-4 text-sm"><div class="font-semibold text-slate-500">Location</div><p>${incident.location}</p><div class="font-semibold text-slate-500">Description</div><p>${incident.description}</p></div><button class="im-back-to-list mt-6 text-indigo-600 font-semibold">← Back to list</button>`; im.listView.classList.add('hidden'); im.formView.classList.add('hidden'); im.detailView.classList.remove('hidden'); };
        
        document.getElementById('incident-management-module').addEventListener('click', (e) => {
            if (e.target.closest('#im-new-report-btn')) { im.listView.classList.add('hidden'); im.formView.classList.remove('hidden'); }
            if (e.target.closest('#im-cancel-btn')) { im.formView.classList.add('hidden'); im.listView.classList.remove('hidden'); im.form.reset(); im.fileList.innerHTML = ''; }
            if (e.target.closest('.im-card')) { showIncidentDetail(Number(e.target.closest('.im-card').dataset.id)); }
            if (e.target.closest('.im-back-to-list')) { im.detailView.classList.add('hidden'); im.listView.classList.remove('hidden'); }
            if (e.target.closest('#im-get-location-btn')) { const btn = e.target.closest('#im-get-location-btn'); const originalIcon = btn.innerHTML; btn.innerHTML = '<div class="loader"></div>'; navigator.geolocation.getCurrentPosition(pos => { document.getElementById('im-location').value = `GPS: ${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`; btn.innerHTML = originalIcon; }, () => { alert('Could not get location.'); btn.innerHTML = originalIcon; }); }
        });
        im.form.addEventListener('submit', (e) => { e.preventDefault(); const formData = new FormData(im.form); incidents.unshift({ id: Date.now(), title: formData.get('title'), location: formData.get('location'), description: formData.get('description'), plant: formData.get('plant'), department: formData.get('department'), status: 'Open', files: Array.from(im.fileUpload.files).map(f => f.name) }); im.form.reset(); im.fileList.innerHTML = ''; im.formView.classList.add('hidden'); im.listView.classList.remove('hidden'); renderIncidentList(); });
        im.fileUpload.addEventListener('change', () => { im.fileList.innerHTML = Array.from(im.fileUpload.files).map(f => `<div class="text-xs text-slate-600 p-1 bg-slate-200 rounded">${f.name}</div>`).join(''); });

        // --- Dashboard Setup ---
        const dashboardTabs = document.getElementById('dashboard-tabs');
        const dashboardContent = document.getElementById('dashboard-content');
        const dashboards = [ { name: 'Incident Mgt.', charts: ['incident-category-chart', 'severity-distribution-chart', 'monthly-incidents-chart'] }, { name: 'CAPA', charts: ['capa-status-chart'] }, { name: 'Work Permits', charts: ['permit-status-chart', 'permit-monthly-chart'] }, { name: 'Safety Audits', charts: ['audit-type-chart', 'audit-score-chart'] }, { name: 'Compliance', charts: [] } ];
        dashboards.forEach((d, i) => { const btn = document.createElement('button'); btn.className = `dashboard-tab whitespace-nowrap px-4 py-2 text-sm font-semibold rounded-full transition-colors ${i === 0 ? 'bg-indigo-600 text-white' : 'bg-white text-slate-600'}`; btn.textContent = d.name; btn.dataset.dashboard = d.name; dashboardTabs.appendChild(btn); });
        
        const destroyCharts = () => { for (let id in chartInstances) { if (chartInstances[id]) { chartInstances[id].destroy(); delete chartInstances[id]; } } };
        const renderDashboard = (dashboardName) => {
            destroyCharts();
            const dashboard = dashboards.find(d => d.name === dashboardName);
            if (dashboard.charts.length === 0) { dashboardContent.innerHTML = `<div class="text-center text-slate-500 pt-12">No data available for this view.</div>`; return; }
            dashboardContent.innerHTML = dashboard.charts.map(c => `<div class="bg-white p-4 rounded-xl shadow-md"><div class="h-56"><canvas id="${c}"></canvas></div></div>`).join('');
            if (dashboardName === 'Incident Mgt.') {
                chartInstances['incident-category-chart'] = new Chart(document.getElementById('incident-category-chart'), { type: 'doughnut', data: { labels: ['Chemical', 'Fall', 'Equipment'], datasets: [{ data: [32, 21, 19], backgroundColor: ['#ef4444', '#f97316', '#3b82f6'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } } });
                chartInstances['severity-distribution-chart'] = new Chart(document.getElementById('severity-distribution-chart'), { type: 'bar', data: { labels: ['First Aid', 'Lost Time', 'Medical'], datasets: [{ data: [24, 30, 18], backgroundColor: ['#22c55e', '#a855f7', '#3b82f6'] }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } } });
                chartInstances['monthly-incidents-chart'] = new Chart(document.getElementById('monthly-incidents-chart'), { type: 'bar', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May'], datasets: [{ label: 'Near Miss', data: [8, 10, 6, 8, 3], backgroundColor: '#22c55e' }, { label: 'Injury', data: [3, 7, 4, 3, 2], backgroundColor: '#ef4444' }, { label: 'Spill', data: [0, 3, 6, 5, 4], backgroundColor: '#f97316' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } }, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } } });
            } else if (dashboardName === 'CAPA') {
                 chartInstances['capa-status-chart'] = new Chart(document.getElementById('capa-status-chart'), { type: 'doughnut', data: { labels: ['Open', 'In Progress', 'Closed'], datasets: [{ data: [25, 25, 24], backgroundColor: ['#3b82f6', '#f97316', '#6b7280'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } } });
            } else if (dashboardName === 'Work Permits') {
                chartInstances['permit-status-chart'] = new Chart(document.getElementById('permit-status-chart'), { type: 'bar', data: { labels: ['Confined Space', 'Hot Work', 'Work at Height'], datasets: [{ label: 'Draft', data: [10, 8, 10], backgroundColor: '#9ca3af' }, { label: 'Issued', data: [12, 10, 12], backgroundColor: '#34d399' }, { label: 'Active', data: [14, 8, 14], backgroundColor: '#3b82f6' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } }, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } } });
                chartInstances['permit-monthly-chart'] = new Chart(document.getElementById('permit-monthly-chart'), { type: 'bar', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May'], datasets: [{ label: 'Confined Space', data: [10, 18, 10, 18, 12], backgroundColor: '#60a5fa' }, { label: 'Work at Height', data: [8, 6, 5, 7, 4], backgroundColor: '#a78bfa' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } } });
            } else if (dashboardName === 'Safety Audits') {
                chartInstances['audit-type-chart'] = new Chart(document.getElementById('audit-type-chart'), { type: 'bar', data: { labels: ['Compliance', 'External', 'Internal'], datasets: [{ label: 'Open', data: [7, 8, 12], backgroundColor: '#3b82f6' }, { label: 'Closed', data: [8, 7, 8], backgroundColor: '#6b7280' }, { label: 'Verified', data: [9, 7, 10], backgroundColor: '#10b981' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } }, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } } });
                chartInstances['audit-score-chart'] = new Chart(document.getElementById('audit-score-chart'), { type: 'bar', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May'], datasets: [{ label: 'Internal', data: [74, 82, 77, 90, 74], backgroundColor: '#a78bfa' }, { label: 'External', data: [78, 91, 75, 74, 78], backgroundColor: '#fb923c' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } } });
            }
        };
        
        dashboardTabs.addEventListener('click', (e) => {
            const tab = e.target.closest('.dashboard-tab');
            if (!tab) return;
            document.querySelectorAll('.dashboard-tab').forEach(t => { t.classList.replace('bg-indigo-600', 'bg-white'); t.classList.replace('text-white', 'text-slate-600'); });
            tab.classList.replace('bg-white', 'bg-indigo-600');
            tab.classList.replace('text-slate-600', 'text-white');
            renderDashboard(tab.dataset.dashboard);
        });

        // --- Initial Load ---
        renderIncidentList();
        renderDashboard('Incident Mgt.');
    });
    </script>

</body>
</html>
