import React, { useState } from 'react';
import { Plus, ChevronDown, FileUp, MapPin, Building, Briefcase, Trash2, Crosshair, Loader } from 'lucide-react';

// Mock data for departments
const departments = [
  "Operations",
  "Health & Safety",
  "Security",
  "Maintenance",
  "Logistics",
  "Human Resources",
  "IT Services"
];

// Main App Component
const App = () => {
  const [incidents, setIncidents] = useState([
    { id: 1, title: "Minor Slip and Fall", department: "Health & Safety", location: "Warehouse Section A", status: "Open" },
    { id: 2, title: "Forklift Collision Near Dock 3", department: "Logistics", location: "Loading Bay", status: "In Progress" },
    { id: 3, title: "Power Outage in West Wing", department: "Maintenance", location: "Plant 2", status: "Closed" },
  ]);
  const [isFormVisible, setIsFormVisible] = useState(false);
  const [selectedIncident, setSelectedIncident] = useState(null);

  const handleAddIncident = (newIncident) => {
    setIncidents(prev => [{ ...newIncident, id: prev.length + 1, status: 'Open' }, ...prev]);
    setIsFormVisible(false);
  };

  const handleSelectIncident = (incident) => {
    setSelectedIncident(incident);
  };
  
  const handleBackToList = () => {
    setSelectedIncident(null);
  }

  const showForm = () => {
    setSelectedIncident(null);
    setIsFormVisible(true);
  }
  
  const hideForm = () => {
      setIsFormVisible(false);
  }

  return (
    <div className="bg-gray-50 min-h-screen font-sans text-gray-800">
      <div className="container mx-auto max-w-lg p-4">
        <Header />
        
        <main>
          {!isFormVisible && !selectedIncident && (
            <>
              <div className="flex justify-between items-center mb-6">
                <h1 className="text-2xl font-bold text-gray-900">Incidents</h1>
                <button
                  onClick={showForm}
                  className="flex items-center gap-2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                >
                  <Plus size={20} />
                  <span>New Report</span>
                </button>
              </div>
              <IncidentList incidents={incidents} onSelectIncident={handleSelectIncident} />
            </>
          )}

          {isFormVisible && (
            <IncidentForm onSubmit={handleAddIncident} onCancel={hideForm} />
          )}
          
          {selectedIncident && !isFormVisible && (
              <IncidentDetail incident={selectedIncident} onBack={handleBackToList} />
          )}
        </main>
      </div>
    </div>
  );
};

// Header Component
const Header = () => (
  <header className="py-4 mb-4">
    <div className="text-center">
      <h2 className="text-3xl font-extrabold text-gray-900">Incident Manager</h2>
      <p className="text-gray-500 mt-1">Report and track incidents efficiently.</p>
    </div>
  </header>
);

// Incident List Component
const IncidentList = ({ incidents, onSelectIncident }) => (
  <div className="space-y-4">
    {incidents.map(incident => (
      <div key={incident.id} onClick={() => onSelectIncident(incident)} className="bg-white p-5 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-300 cursor-pointer">
        <div className="flex justify-between items-start">
          <div>
            <h3 className="font-bold text-lg text-gray-800">{incident.title}</h3>
            <p className="text-sm text-gray-500 mt-1 flex items-center gap-2"><Briefcase size={14} /> {incident.department}</p>
            <p className="text-sm text-gray-500 mt-1 flex items-center gap-2"><MapPin size={14} /> {incident.location}</p>
          </div>
          <StatusBadge status={incident.status} />
        </div>
      </div>
    ))}
  </div>
);

// Incident Detail View
const IncidentDetail = ({ incident, onBack }) => (
    <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
        <button onClick={onBack} className="text-blue-600 hover:underline mb-4">&larr; Back to list</button>
        <h2 className="text-2xl font-bold mb-2">{incident.title}</h2>
        <StatusBadge status={incident.status} />
        <div className="mt-6 space-y-4">
            <div>
                <h4 className="font-semibold text-gray-600">Department</h4>
                <p className="text-gray-800">{incident.department}</p>
            </div>
            <div>
                <h4 className="font-semibold text-gray-600">Location</h4>
                <p className="text-gray-800">{incident.location}</p>
            </div>
             <div>
                <h4 className="font-semibold text-gray-600">Description</h4>
                <p className="text-gray-800 bg-gray-50 p-3 rounded-md">This is a placeholder for the detailed description of the incident. In a real application, this would be saved and displayed from the incident object.</p>
            </div>
        </div>
    </div>
);


// Status Badge Component
const StatusBadge = ({ status }) => {
  const statusStyles = {
    Open: 'bg-green-100 text-green-800',
    'In Progress': 'bg-yellow-100 text-yellow-800',
    Closed: 'bg-gray-200 text-gray-600',
  };
  return (
    <span className={`px-3 py-1 text-xs font-semibold rounded-full ${statusStyles[status]}`}>
      {status}
    </span>
  );
};


// Incident Form Component
const IncidentForm = ({ onSubmit, onCancel }) => {
  const [title, setTitle] = useState('');
  const [description, setDescription] = useState('');
  const [location, setLocation] = useState('');
  const [department, setDepartment] = useState('');
  const [plant, setPlant] = useState('');
  const [files, setFiles] = useState([]);
  const [isFetchingLocation, setIsFetchingLocation] = useState(false);

  const handleFileChange = (e) => {
    if (e.target.files) {
      setFiles(prev => [...prev, ...Array.from(e.target.files)]);
    }
  };

  const removeFile = (index) => {
    setFiles(prev => prev.filter((_, i) => i !== index));
  };
  
  const handleSubmit = (e) => {
    e.preventDefault();
    if (!title || !description || !location || !department) {
        // In a real app, use a modal or toast notification
        console.error("Please fill all required fields.");
        return;
    }
    onSubmit({ title, description, location, department, plant });
  };

  const handleGetLocation = () => {
    if (!navigator.geolocation) {
      console.error("Geolocation is not supported by this browser.");
      setLocation("Geolocation not supported.");
      return;
    }

    setIsFetchingLocation(true);
    
    // Mock reverse geocoding
    const reverseGeocode = (lat, lon) => {
        return new Promise(resolve => {
            setTimeout(() => {
                resolve("Bengaluru, Karnataka, India (from GPS)");
            }, 1500); // Simulate API call
        });
    };

    navigator.geolocation.getCurrentPosition(
      async (position) => {
        const { latitude, longitude } = position.coords;
        const address = await reverseGeocode(latitude, longitude);
        setLocation(address);
        setIsFetchingLocation(false);
      },
      (error) => {
        console.error("Error getting location:", error.message);
        setLocation("Location access denied.");
        setIsFetchingLocation(false);
      }
    );
  };


  return (
    <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8">
      <h2 className="text-xl font-bold mb-6 text-center">Submit New Incident</h2>
      <form onSubmit={handleSubmit} className="space-y-6">
        <InputField label="Title" value={title} onChange={e => setTitle(e.target.value)} placeholder="e.g., Minor Slip and Fall" required />
        
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
          <textarea
            value={description}
            onChange={e => setDescription(e.target.value)}
            placeholder="Provide a detailed account of the incident..."
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
            rows="4"
            required
          ></textarea>
        </div>

        <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Location</label>
            <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <MapPin size={18} className="text-gray-400" />
                </div>
                <input
                    value={location}
                    onChange={e => setLocation(e.target.value)}
                    placeholder="e.g., Warehouse Section A"
                    required
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 pl-10 pr-10"
                />
                <button type="button" onClick={handleGetLocation} disabled={isFetchingLocation} className="absolute inset-y-0 right-0 pr-3 flex items-center text-blue-600 hover:text-blue-800 disabled:text-gray-400 disabled:cursor-wait">
                    {isFetchingLocation ? <Loader size={18} className="animate-spin" /> : <Crosshair size={18} />}
                </button>
            </div>
        </div>

        <InputField icon={<Building size={18} className="text-gray-400" />} label="Plant (Optional)" value={plant} onChange={e => setPlant(e.target.value)} placeholder="e.g., Main Production Facility" />
        
        <SelectField label="Department" value={department} onChange={e => setDepartment(e.target.value)} options={departments} required />

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Evidence (Photos, Videos, Docs)</label>
          <div className="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
            <div className="space-y-1 text-center">
              <FileUp className="mx-auto h-12 w-12 text-gray-400" />
              <div className="flex text-sm text-gray-600">
                <label htmlFor="file-upload" className="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                  <span>Upload files</span>
                  <input id="file-upload" name="file-upload" type="file" className="sr-only" multiple onChange={handleFileChange} />
                </label>
                <p className="pl-1">or drag and drop</p>
              </div>
              <p className="text-xs text-gray-500">PNG, JPG, GIF, MP4, PDF up to 10MB</p>
            </div>
          </div>
          {files.length > 0 && (
            <div className="mt-4 space-y-2">
                <h4 className="font-semibold text-sm">Attached files:</h4>
                {files.map((file, index) => (
                    <div key={index} className="flex items-center justify-between bg-gray-100 p-2 rounded-md">
                        <span className="text-sm text-gray-700 truncate">{file.name}</span>
                        <button type="button" onClick={() => removeFile(index)} className="text-red-500 hover:text-red-700">
                            <Trash2 size={16} />
                        </button>
                    </div>
                ))}
            </div>
          )}
        </div>

        <div className="flex items-center justify-end gap-4 pt-4">
          <button
            type="button"
            onClick={onCancel}
            className="py-2 px-6 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors"
          >
            Cancel
          </button>
          <button
            type="submit"
            className="py-2 px-6 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            Submit Report
          </button>
        </div>
      </form>
    </div>
  );
};

// Reusable Input Field Component
const InputField = ({ icon, label, ...props }) => (
  <div>
    <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
    <div className="relative">
      {icon && <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">{icon}</div>}
      <input
        {...props}
        className={`w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ${icon ? 'pl-10' : ''}`}
      />
    </div>
  </div>
);

// Reusable Select Field Component
const SelectField = ({ label, value, onChange, options, required }) => (
  <div>
    <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
    <div className="relative">
      <select
        value={value}
        onChange={onChange}
        required={required}
        className="w-full appearance-none bg-white px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 pr-8"
      >
        <option value="" disabled>Select a department</option>
        {options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
      </select>
      <div className="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
        <ChevronDown size={20} className="text-gray-400" />
      </div>
    </div>
  </div>
);


export default App;
